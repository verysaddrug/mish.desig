# Как ускорить запросы

## Почему запросы работают медленно

1. **Много вычислений каждый раз**
   - При каждом запросе заново считаются рейтинги для всех пользователей
   - Сортировка 10+ миллионов строк занимает много времени

2. **Большие таблицы**
   - 10 миллионов пользователей
   - Много записей о дружбе

3. **Сложные объединения таблиц**
   - Много JOIN операций в одном запросе
   - Сложные подзапросы

## Способы ускорения

### 1. Материализованные представления

Что это: Заранее вычисленные и сохраненные результаты сложных запросов

```sql
CREATE MATERIALIZED VIEW user_rankings AS
SELECT id, username, city, points, RANK() OVER (ORDER BY points DESC) AS overall_rank
FROM users;
```

Плюсы:
- Не нужно каждый раз заново вычислять рейтинги
- Запросы становятся намного быстрее

Минусы:
- Нужно периодически обновлять данные
- Занимает дополнительное место в базе

### 2. Разделение таблицы пользователей по городам

Что это: Хранение пользователей разных городов в отдельных физических таблицах

```sql
CREATE TABLE users_partitioned (...) PARTITION BY LIST (city);
CREATE TABLE users_moscow PARTITION OF users_partitioned FOR VALUES IN ('Москва');
```

Плюсы:
- Запросы для конкретного города работают только с нужной частью данных
- Ускоряет запросы, фильтрующие по городу

### 3. Индексы

Что это: Специальные структуры для быстрого поиска в таблице

```sql
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_points ON users(points DESC);
```

Плюсы:
- Ускоряют поиск конкретных значений
- Ускоряют сортировку по индексированным полям

### 4. Регулярное обслуживание базы

Команды для поддержания производительности:
```sql
REFRESH MATERIALIZED VIEW user_rankings;  -- Обновляет сохраненные данные
```

## Как использовать оптимизации

1. Запустить оптимизированные запросы:
   Выполнить SQL-запрос из файла `/requests/user_rating_optimized.sql`

2. Обновить материализованные представления:
   Выполнить SQL-запрос из файла `/migrations/refresh_materialized_views.sql`

## Как проверить производительность

Добавьте EXPLAIN ANALYZE перед запросом:
```sql
EXPLAIN ANALYZE SELECT * FROM users WHERE username = 'user123';
```

Это покажет, как именно выполняется запрос и сколько времени занимает каждый шаг. 