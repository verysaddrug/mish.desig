# Задача 3: Оптимизация

## Что нужно сделать

1. Добавить индексы для ускорения запросов
2. Описать способы оптимизации: CTE, индексы, материализованные представления и др.

## Как решено

### Добавлены индексы

Для ускорения запросов добавлены индексы:

```sql
-- Для таблицы users
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_city ON users(city);
CREATE INDEX idx_users_points ON users(points DESC);

-- Для таблицы friends
CREATE INDEX idx_friends_user_id ON friends(user_id);
CREATE INDEX idx_friends_friend_id ON friends(friend_id);
```

### Основные способы оптимизации

1. **Материализованные представления**
   - Предварительно рассчитывают рейтинги
   - Хранят готовые результаты
   - Обновляются по расписанию

2. **Партиционирование**
   - Разделение таблицы users по городам
   - Каждый город хранится в отдельной физической таблице
   - Запросы по городу работают только с нужной частью данных

3. **Оптимизация запросов**
   - Использование CTE для улучшения читаемости
   - Использование оконных функций вместо подзапросов
   - Ограничение количества возвращаемых строк (LIMIT)

4. **Регулярное обслуживание**
   - Команда `VACUUM ANALYZE` для обновления статистики
   - Регулярное обновление материализованных представлений

## Как запустить оптимизацию

Выполнить SQL-запросы:
1. `/migrations/refresh_materialized_views.sql`
2. `VACUUM ANALYZE users;`
3. `VACUUM ANALYZE friends;`

Для оптимизированных запросов:
Выполнить SQL-запрос из файла `/requests/user_rating_optimized.sql` 